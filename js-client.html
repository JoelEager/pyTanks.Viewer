<!DOCTYPE html>
<html>
	<head>
		<title>pyTanks Viewer</title>
	</head>
	<body>
		<center>
			<canvas id="canvas" width="500" height="500" style="border:1px solid #d3d3d3;">Please upgrade your browser.</canvas>
		</center>
		<script>
			// Client configuration - must match server's settings
			var config = {
				framesPerSecond: 60,	// FPS to run the simulation at
				mapSize: {				// Size of the map (must be the same as the canvas size)
					x: 500,
					y: 500
				},
				tankSpeed: 25,			// Tank speed in pixels per second
				shellSpeed: 100			// Shell speed in pixels per second
			}
		
			var ws = new WebSocket("ws://127.0.0.1:5678/pyTanksAPI/viewer");
			var myDrawer = document.getElementById("canvas").getContext("2d");
			var gameState = null;
			var newGameState = null;
			
			ws.onmessage = function (event) {
				newGameState = JSON.parse(event.data);
			};
			
			function doTick() {
				// Return if no data from the server has arrived yet
				if (gameState == null && newGameState == null) {
					return
				}
				
				if (newGameState == null) {
					// Extrapolate if there isn't an update from the server
					var totalDistance = config.tankSpeed * (1 / config.framesPerSecond);
					for (tank of gameState.tanks) {
						if (tank.moving) {
							tank.x += Math.cos(tank.heading) * totalDistance;
							tank.y += Math.sin(tank.heading) * totalDistance;
						}
					}
					
					totalDistance = config.shellSpeed * (1 / config.framesPerSecond);
					for (shell of gameState.shells) {
						shell.x += Math.cos(shell.heading) * totalDistance;
						shell.y += Math.sin(shell.heading) * totalDistance;
					}
				} else {
					// Apply the update from the server
					gameState = newGameState;
					newGameState = null;
				}
				
				// Render based on that game state
				myDrawer.clearRect(0, 0, config.mapSize.x, config.mapSize.y);
				myDrawer.fillStyle = "Black";
				for (tank of gameState.tanks) {
					myDrawer.fillRect(tank.x, tank.y, 10, 10);
				}
				myDrawer.fillStyle = "Red";
				for (shell of gameState.shells) {
					myDrawer.fillRect(shell.x, shell.y, 4, 4);
				}
			}
			
			window.setInterval(function(){ doTick(); }, 1000 / config.framesPerSecond);
		</script>
	</body>
</html>